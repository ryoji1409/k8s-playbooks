---
- name: Validate required user fields
  ansible.builtin.fail:
    msg: "User {{ user_item.username | default('unknown') }} missing required fields: username, password, email"
  when:
    - user_item.username is not defined or user_item.username | length == 0
    - user_item.password is not defined or user_item.password | length == 0
    - user_item.email is not defined or user_item.email | length == 0

- name: Create local Rancher user - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/users"
    method: POST
    headers:
      Authorization: "{{ rancher_api_bearer }}"
      Content-Type: "application/json"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200, 201, 422]
    body:
      type: user
      username: "{{ user_item.username }}"
      password: "{{ user_item.password }}"
      email: "{{ user_item.email }}"
      displayName: "{{ user_item.display_name | default(user_item.username) }}"
      description: "{{ user_item.description | default('') }}"
      enabled: "{{ user_item.enabled | default(true) }}"
  register: user_create
  changed_when: user_create.status in [200, 201]

- name: Get user ID if user already exists - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/users?username={{ user_item.username }}"
    method: GET
    headers:
      Authorization: "{{ rancher_api_bearer }}"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200]
  register: user_get
  when: user_create.status == 422
  changed_when: false

- name: Set user_id fact for existing user - {{ user_item.username }}
  ansible.builtin.set_fact:
    user_create: "{{ {'json': {'id': user_get.json.data[0].id}} }}"
  when: user_create.status == 422 and user_get.json.data | length > 0

- name: Update user email and attributes - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/users/{{ user_create.json.id }}"
    method: PUT
    headers:
      Authorization: "{{ rancher_api_bearer }}"
      Content-Type: "application/json"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200, 201]
    body:
      type: user
      username: "{{ user_item.username }}"
      email: "{{ user_item.email }}"
      displayName: "{{ user_item.display_name | default(user_item.username) }}"
      description: "{{ user_item.description | default('') }}"
      enabled: "{{ user_item.enabled | default(true) }}"
  register: user_update
  changed_when: user_update.status in [200, 201]

- name: Grant global admin role - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/globalrolebindings"
    method: POST
    headers:
      Authorization: "{{ rancher_api_bearer }}"
      Content-Type: "application/json"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200, 201, 422]
    body:
      type: globalRoleBinding
      globalRoleId: admin
      userId: "{{ user_create.json.id }}"
  register: admin_role
  when: user_item.is_admin | default(false) | bool
  changed_when: admin_role.status in [200, 201]

- name: Grant cluster role - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/clusterroletemplatebindings"
    method: POST
    headers:
      Authorization: "{{ rancher_api_bearer }}"
      Content-Type: "application/json"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200, 201, 422]
    body:
      type: clusterRoleTemplateBinding
      clusterId: "{{ item.cluster_id }}"
      roleTemplateId: "{{ item.role }}"
      userPrincipalId: "local://{{ user_create.json.id }}"
  loop: "{{ user_item.cluster_roles | default([]) }}"
  when: user_item.cluster_roles is defined and user_item.cluster_roles | length > 0
  changed_when: true

- name: Display user details - {{ user_item.username }}
  ansible.builtin.debug:
    msg:
      - "User: {{ user_item.username }}"
      - "Email: {{ user_item.email }}"
      - "Display Name: {{ user_item.display_name | default(user_item.username) }}"
      - "Status: {{ 'Created' if user_create is changed else 'Already exists' }}"
      - "Admin: {{ user_item.is_admin | default(false) }}"
      - "Cluster Roles: {{ user_item.cluster_roles | default([]) | length }} role(s)"
