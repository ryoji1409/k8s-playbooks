---
- name: Validate required user fields
  ansible.builtin.fail:
    msg: "User {{ user_item.username | default('unknown') }} missing required fields: username"
  when:
    - user_item.username is not defined or user_item.username | length == 0

- name: Check if user already exists - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/users?username={{ user_item.username }}"
    method: GET
    headers:
      Authorization: "bearer {{ rancher_api_token}}"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200]
  register: user_exists_check
  changed_when: false

- name: Set user_exists fact
  ansible.builtin.set_fact:
    user_exists: "{{ user_exists_check.json.data | length > 0 }}"

- name: Generate random password if requested - {{ user_item.username }}
  ansible.builtin.set_fact:
    user_password: "{{ lookup('password', '/dev/null length=16 chars=ascii_letters,digits,punctuation') }}"
    password_generated: true
  when:
    - not user_exists

- name: Display generated password - {{ user_item.username }}
  ansible.builtin.debug:
    msg: "Generated password for user {{ user_item.username }}: {{ user_password }}"
  when:
    - not user_exists

- name: Create local Rancher user - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/users"
    method: POST
    headers:
      Authorization: "bearer {{ rancher_api_token}}"
      Content-Type: "application/json"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200, 201, 422]
    body:
      type: user
      username: "{{ user_item.username }}"
      password: "{{ user_password }}"
      name: "{{ user_item.display_name | default(user_item.username) }}"
      description: "{{ user_item.description | default('') }}"
      enabled: "{{ user_item.enabled | default(true) }}"
      mustChangePassword: "{{ user_item.must_change_password | default(false) }}"
  register: user_create
  changed_when: user_create.status in [200, 201]
  when: not user_exists
  no_log: true

- name: Get user ID if user already exists - {{ user_item.username }}
  ansible.builtin.set_fact:
    user_create: "{{ {'json': {'id': user_exists_check.json.data[0].id}} }}"
  when: user_exists

- name: Update user attributes - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/users/{{ user_create.json.id }}"
    method: PUT
    headers:
      Authorization: "bearer {{ rancher_api_token}}"
      Content-Type: "application/json"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200, 201]
    body:
      type: user
      username: "{{ user_item.username }}"
      name: "{{ user_item.display_name | default(user_item.username) }}"
      description: "{{ user_item.description | default('') }}"
      enabled: "{{ user_item.enabled | default(true) }}"
  register: user_update
  changed_when: user_update.status in [200, 201]
  when: user_exists

- name: Grant global permissions/role - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/globalrolebindings"
    method: POST
    headers:
      Authorization: "bearer {{ rancher_api_token}}"
      Content-Type: "application/json"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200, 201, 422]
    body:
      type: globalRoleBinding
      globalRoleId: "{{ user_item.global_role | default('user') }}"
      userId: "{{ user_create.json.id }}"
  register: global_role
  when:
    - user_item.global_role is defined
    - not user_exists
  changed_when: global_role.status in [200, 201]

- name: Grant cluster role - {{ user_item.username }}
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/clusterroletemplatebindings"
    method: POST
    headers:
      Authorization: "bearer {{ rancher_api_token}}"
      Content-Type: "application/json"
    validate_certs: "{{ not rancher_insecure_ssl | bool }}"
    body_format: json
    status_code: [200, 201, 422]
    body:
      type: clusterRoleTemplateBinding
      clusterId: "{{ item.item.cluster_id }}"
      roleTemplateId: "{{ item.item.role }}"
      userPrincipalId: "local://{{ user_create.json.id }}"
  loop: "{{ cluster_role_check.results | default([]) }}"
  when:
    - user_item.cluster_roles is defined and user_item.cluster_roles | length > 0
    - not user_exists
  changed_when: true

- name: Display user details - {{ user_item.username }}
  ansible.builtin.debug:
    msg:
      - "User: {{ user_item.username }}"
      - "Display Name: {{ user_item.display_name | default(user_item.username) }}"
      - "Status: {{ 'Created' if user_create is changed else 'Already exists' }}"
      - "Admin: {{ user_item.global_role | default(false) }}"
      - "Cluster Roles: {{ user_item.cluster_roles | default([]) | length }} role(s)"
